#!/bin/bash
#
# STEWARD PROTOCOL - Pre-Commit Guard (Phase 3.1)
# ================================================
# "The Electric Fence" - Fast, dumb, effective
#
# Purpose: Block 95% of architectural violations BEFORE they get committed
# Performance: <50ms (if slower, devs will bypass with --no-verify)
# Philosophy: Fail fast, fail loud, fail early
#
# Enforces:
# 1. No requirements.txt in agent directories (use pyproject.toml)
# 2. No direct Path("data/...") calls (use system.get_sandbox_path())
#
# Part of Defense in Depth:
# - Layer 1 (this): Fast pattern matching (pre-commit)
# - Layer 2: Watchman AST analysis (CI/CD)
# - Layer 3: Auditor verdict (CI/CD)

set -e  # Exit on first error

REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${YELLOW}‚ö° Running Steward Protocol Pre-Commit Guards...${NC}"

# ============================================================================
# GUARD 1: Block requirements.txt in agent directories
# ============================================================================
echo -n "  üîç Checking for requirements.txt in agent dirs... "

# Get list of files to be committed
STAGED_FILES=$(git diff --cached --name-only)

# Check if any requirements.txt in system_agents are staged
if echo "$STAGED_FILES" | grep -q "^steward/system_agents/.*/requirements.txt$"; then
    echo -e "${RED}BLOCKED${NC}"
    echo ""
    echo -e "${RED}‚ùå VIOLATION: requirements.txt found in agent directory${NC}"
    echo ""
    echo "Agent directories must use pyproject.toml for dependencies."
    echo "After Phase 2 migration, requirements.txt is prohibited."
    echo ""
    echo "To fix:"
    echo "  1. Remove the requirements.txt file"
    echo "  2. Add dependencies to pyproject.toml instead"
    echo "  3. Use agent.system.add_dependency() at runtime"
    echo ""
    echo -e "${YELLOW}See: docs/AGENT_CLI_ENFORCEMENT_PLAN.md${NC}"
    exit 1
fi

echo -e "${GREEN}OK${NC}"

# ============================================================================
# GUARD 2: Block direct Path("data/...") patterns
# ============================================================================
echo -n "  üîç Checking for direct Path('data/...') calls... "

# Only check Python files in system_agents that are staged
PYTHON_FILES=$(echo "$STAGED_FILES" | grep "^steward/system_agents/.*\.py$" || true)

if [ -n "$PYTHON_FILES" ]; then
    # Check for Path("data/ or Path('data/ patterns
    VIOLATIONS=$(echo "$PYTHON_FILES" | xargs grep -n "Path([\"']data/" 2>/dev/null || true)

    if [ -n "$VIOLATIONS" ]; then
        echo -e "${RED}BLOCKED${NC}"
        echo ""
        echo -e "${RED}‚ùå VIOLATION: Direct Path('data/...') detected${NC}"
        echo ""
        echo "Agents must use sandboxed filesystem access."
        echo "Direct Path('data/...') bypasses VFS isolation."
        echo ""
        echo "Violations found:"
        echo "$VIOLATIONS" | while read line; do
            echo "  ‚Ä¢ $line"
        done
        echo ""
        echo "To fix:"
        echo "  1. Use agent.system.get_sandbox_path() instead"
        echo "  2. Convert to lazy-loading @property pattern"
        echo "  3. See Phase 2.3 migration examples (Herald, Forum, Civic)"
        echo ""
        echo -e "${YELLOW}See: docs/AGENT_CLI_ENFORCEMENT_PLAN.md${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}OK${NC}"

# ============================================================================
# GUARD 3: Block direct open() calls with hardcoded paths in __init__
# ============================================================================
echo -n "  üîç Checking for hardcoded paths in __init__... "

if [ -n "$PYTHON_FILES" ]; then
    # Look for suspicious patterns like Path(".") or Path("steward") in __init__ methods
    # This catches agents initializing paths before system interface injection
    INIT_VIOLATIONS=$(echo "$PYTHON_FILES" | xargs grep -n "def __init__" -A 20 2>/dev/null | \
        grep -E "Path\([\"']\.|Path\([\"']steward|Path\([\"']vibe_core" | \
        grep -v "# PHASE 2" | \
        grep -v "lazy-load" || true)

    if [ -n "$INIT_VIOLATIONS" ]; then
        echo -e "${YELLOW}WARNING${NC}"
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  SUSPICIOUS: Hardcoded paths detected in __init__${NC}"
        echo ""
        echo "After Phase 2.3, agents should use lazy-loading for paths."
        echo "Paths initialized in __init__ may execute before system interface injection."
        echo ""
        echo "Suspicious patterns:"
        echo "$INIT_VIOLATIONS" | head -10
        echo ""
        echo -e "${YELLOW}This is a WARNING, not a blocker. Review carefully.${NC}"
        echo ""
    fi
fi

echo -e "${GREEN}OK${NC}"

# ============================================================================
# GUARD 4: Auto-format and auto-fix with ruff (replaces black + isort + flake8)
# ============================================================================
# NOTE: This hook auto-formats and re-stages files, which breaks partial staging (git add -p).
# This is intentional for Agent City atomicity - commit entire files, not hunks.
# To bypass: git commit --no-verify (NOT RECOMMENDED)

echo -n "  üé® Running ruff format + check... "

# Get ALL staged Python files (not just system_agents)
ALL_PYTHON_FILES=$(echo "$STAGED_FILES" | grep "\.py$" || true)

if [ -n "$ALL_PYTHON_FILES" ]; then
    # Auto-format staged Python files (replaces black + isort)
    echo "$ALL_PYTHON_FILES" | xargs ruff format --quiet 2>/dev/null || true

    # Auto-fix safe linting issues
    echo "$ALL_PYTHON_FILES" | xargs ruff check --fix --quiet 2>/dev/null || true

    # Restage formatted/fixed files
    echo "$ALL_PYTHON_FILES" | xargs git add 2>/dev/null || true

    # Check for CRITICAL errors that cannot be auto-fixed
    # Note: --quiet suppresses "All checks passed!" message, only shows errors
    RUFF_ERRORS=$(echo "$ALL_PYTHON_FILES" | xargs ruff check --select=E9,F63,F7,F82 --quiet 2>/dev/null || true)

    if [ -n "$RUFF_ERRORS" ]; then
        echo -e "${RED}BLOCKED${NC}"
        echo ""
        echo -e "${RED}‚ùå CRITICAL SYNTAX ERRORS DETECTED${NC}"
        echo ""
        echo "$RUFF_ERRORS"
        echo ""
        echo "Fix these errors before committing."
        exit 1
    fi

    echo -e "${GREEN}OK (auto-formatted + checked)${NC}"
else
    echo -e "${GREEN}SKIP (no Python files)${NC}"
fi

# ============================================================================
# All guards passed
# ============================================================================
echo -e "${GREEN}‚úÖ All pre-commit guards passed${NC}"
echo ""

exit 0
