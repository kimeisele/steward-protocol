import os
import logging
from github import Github
from herald.tools.content_tool import ContentTool

logger = logging.getLogger("WATCHMAN_AGENT")

class WatchmanCartridge:
    """
    Agent: watchman
    Mission: Monitor GitHub Issues and label them based on urgency. Act as the immune system for the repository.
    Generated by: The Engineer (Upgraded by Senior Architect)
    """

    def __init__(self):
        """Initialize Watchman with GitHub and AI capabilities."""
        self.github_token = os.environ.get("GITHUB_TOKEN")
        self.content_tool = ContentTool()
        
        if self.github_token:
            self.gh = Github(self.github_token)
            logger.info("âœ… Connected to GitHub")
        else:
            self.gh = None
            logger.warning("âš ï¸  No GITHUB_TOKEN found. Read-only mode (or failure expected).")

        logger.info("watchman is online.")

    def run(self):
        logger.info("watchman is running its mission: Monitor GitHub Issues and label them based on urgency.")
        return {"status": "success", "message": "watchman executed successfully"}

    def triage_issue(self, issue_id: int) -> dict:
        """
        Analyze and triage a specific GitHub issue.
        
        Args:
            issue_id: The issue number
            
        Returns:
            dict: Result of the operation
        """
        if not self.gh:
            return {"status": "error", "message": "No GitHub Token"}

        try:
            # Get Repo and Issue
            # Assuming we run in the repo context, getting 'owner/repo' from env or git config would be ideal
            # For now, we'll try to get it from GITHUB_REPOSITORY env var (set by Actions)
            repo_name = os.environ.get("GITHUB_REPOSITORY")
            if not repo_name:
                # Fallback for local testing if not set
                repo_name = "kimeisele/steward-protocol" 
            
            repo = self.gh.get_repo(repo_name)
            issue = repo.get_issue(issue_id)
            
            logger.info(f"ðŸ‘€ Analyzing Issue #{issue_id}: {issue.title}")
            
            # Analyze with LLM
            analysis = self._analyze_content(issue.title, issue.body)
            
            # Post Comment
            comment_body = (
                f"ðŸ‘€ **WATCHMAN Protocol Initiated**\n\n"
                f"Analyzing issue content...\n\n"
                f"> **Assessment**: {analysis}\n\n"
                f"Status: `Triaged`\n"
                f"Signed: `agent.steward.watchman`"
            )
            issue.create_comment(comment_body)
            
            # Add Label
            issue.add_to_labels("status:triaged")
            
            logger.info(f"âœ… Issue #{issue_id} triaged successfully.")
            return {"status": "success", "issue": issue_id, "analysis": analysis}

        except Exception as e:
            logger.error(f"âŒ Triage failed: {e}")
            return {"status": "error", "message": str(e)}

    def _analyze_content(self, title: str, body: str) -> str:
        """Use LLM to analyze urgency and sentiment."""
        if not self.content_tool.client:
            return "Automated analysis unavailable (No LLM). Proceeding with manual review."

        prompt = (
            f"You are THE WATCHMAN, an AI agent responsible for repository health.\n"
            f"Analyze this GitHub Issue:\n"
            f"Title: {title}\n"
            f"Body: {body}\n\n"
            f"Task: Provide a 1-sentence assessment of urgency and category (Bug, Feature, Question).\n"
            f"Tone: Professional, vigilant, concise."
        )
        
        try:
            response = self.content_tool.client.chat.completions.create(
                model="anthropic/claude-3-haiku",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=100,
                temperature=0.3
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            logger.error(f"LLM Analysis failed: {e}")
            return "Analysis failed. Manual review required."
