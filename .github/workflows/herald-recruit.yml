name: HERALD Recruitment Campaign

on:
  schedule:
    # Run every morning at 08:00 UTC
    # This is when HERALD wakes up to generate marketing content
    - cron: '0 8 * * *'

  # Also allow manual trigger for testing
  workflow_dispatch:

jobs:
  create-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # CRITICAL: Allows writing back to the repo

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Get the full history so we can commit properly
          fetch-depth: 0

      - name: Set up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # üî• GAD-100 PHOENIX BOOTSTRAP
      # Install Vibe OS (this repo) as the system layer
      # This provides the core runtime for all agents
      - name: Bootstrap Vibe OS (Phoenix Layer)
        run: |
          python -m pip install --upgrade pip
          echo "ü¶Ö PHOENIX: Bootstrapping Vibe OS..."
          pip install .  # Install vibe-agency (the runtime OS)
          echo "‚úÖ Vibe OS ready"

      # Install agent-specific plugins
      - name: Install Agent Plugins
        run: |
          if [ -f examples/herald/requirements.txt ]; then
            echo "üîå Installing HERALD Agent plugins..."
            pip install -r examples/herald/requirements.txt
            echo "‚úÖ HERALD plugins loaded"
          else
            echo "‚ùå No requirements.txt found for HERALD Agent"
            exit 1
          fi

      # üöÄ Launch HERALD on the Vibe OS runtime
      - name: Ignite HERALD (via Vibe OS)
        env:
          # Phase 2: Multi-Channel Publishing
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY || '' }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET || '' }}
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN || '' }}
          # Phase 3: Research Mode (Web Search for Trending Topics)
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY || '' }}
          # Intelligence: LLM-powered content generation (optional)
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY || '' }}
        run: |
          echo "üöÄ PHOENIX: Igniting HERALD agent..."
          chmod +x examples/herald/campaign.py
          python examples/herald/campaign.py
          echo "‚úÖ HERALD execution complete"

      - name: Configure Git for Commits
        run: |
          git config --global user.name "HERALD Agent"
          git config --global user.email "herald@steward.local"

      - name: Commit & Push Generated Content
        run: |
          # Check if there are new files in content/posts/
          if [ -d "content/posts" ] && [ -n "$(git status --short content/posts/)" ]; then
            git add content/posts/

            # Get today's date for the commit message
            TODAY=$(date +"%Y-%m-%d")

            # Commit with an emoji and clear message
            git commit -m "ü§ñ HERALD: Generated recruitment post for $TODAY"

            # Push back to the current branch
            git push

            echo "‚úÖ Content pushed successfully"
          else
            echo "‚ÑπÔ∏è  No new content to commit (already generated today)"
          fi

      - name: Report Status
        if: always()
        run: |
          echo "üìä HERALD Campaign Workflow Complete"
          echo "Time: $(date -u)"
          if [ -d "content/posts" ]; then
            echo "üìÅ Generated posts:"
            ls -lh content/posts/ 2>/dev/null || echo "   (directory exists but empty)"
          fi
          echo ""
          echo "üí° HERALD Capability Status:"
          echo ""
          echo "  Phase 2 - Multi-Channel Publishing:"
          if [ -z "${{ secrets.TWITTER_API_KEY }}" ]; then
            echo "   üì¢ Twitter: NOT CONFIGURED (daily posts disabled)"
          else
            echo "   ‚úÖ Twitter: READY (HERALD posts daily)"
          fi
          if [ -z "${{ secrets.LINKEDIN_ACCESS_TOKEN }}" ]; then
            echo "   üìã LinkedIn: NOT CONFIGURED (weekly posts disabled)"
          else
            echo "   ‚úÖ LinkedIn: READY (HERALD posts on Fridays)"
          fi
          echo ""
          echo "  Phase 3 - Research Mode:"
          if [ -z "${{ secrets.TAVILY_API_KEY }}" ]; then
            echo "   üîç Research: DISABLED (using rotation mode)"
            echo "      To enable: Set TAVILY_API_KEY in GitHub Secrets"
          else
            echo "   ‚úÖ Research: ENABLED (HERALD searches for trends daily)"
          fi
          if [ -z "${{ secrets.OPENROUTER_API_KEY }}" ]; then
            echo "   üß† Intelligence: DISABLED (using basic hot takes)"
            echo "      To enable: Set OPENROUTER_API_KEY in GitHub Secrets"
          else
            echo "   ‚úÖ Intelligence: ENABLED (LLM-powered analysis)"
          fi
