name: "üèõÔ∏è Agent City Auto-Update"

on:
  schedule:
    - cron: "0 */6 * * *"  # Every 6 hours
  workflow_dispatch:

jobs:
  update_leaderboard:
    name: "üìä Update Leaderboard"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "üêç Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "üì¶ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install Pillow

      - name: "üìä Collect Stats"
        run: |
          PYTHONPATH=. python3 agent-city/scripts/collect_stats.py

      - name: "üèÜ Generate Leaderboard"
        run: |
          PYTHONPATH=. python3 agent-city/scripts/generate_leaderboard.py

      - name: "üé® Render Dashboard"
        run: |
          PYTHONPATH=. python3 agent-city/scripts/render_dashboard.py

      - name: "üíæ Commit Changes"
        run: |
          git config --global user.name "Agent City Bot"
          git config --global user.email "agent-city@steward.protocol"

          if git diff --quiet agent-city/stats/ agent-city/LEADERBOARD.md docs/agent-city/ 2>/dev/null; then
            echo "‚ÑπÔ∏è  No changes to Agent City stats"
          else
            git add agent-city/stats/ agent-city/LEADERBOARD.md docs/agent-city/
            git commit -m "chore: Update Agent City stats [skip ci]"
            git push || { echo "‚ùå CRITICAL: Failed to push Agent City stats!"; exit 1; }
            echo "‚úÖ Agent City stats committed and pushed"
          fi
