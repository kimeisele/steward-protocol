name: Protocol Attestation

on:
  # 1. Automatisch alle 6 Stunden
  schedule:
    - cron: '0 */6 * * *'
  # 2. Bei jedem Push auf main/Entwicklungsbranches
  push:
    branches: [ main, 'claude/**' ]
    paths:
      - 'STEWARD.md'
      - 'examples/**/STEWARD.md'
      - 'setup.py'
      - 'steward/**'
  # 3. Manuell triggerbar
  workflow_dispatch:

jobs:
  verify-agents:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Steward Protocol CLI
        run: |
          echo "ğŸ“¦ Installing STEWARD CLI from local code..."
          pip install --quiet -e . 2>&1 | grep -v "AttributeError" || true
          # Fallback: Ensure steward CLI is available via direct module invocation
          python -m steward.cli --version || echo "steward" > /tmp/steward_installed

      - name: Verify Organization Identity (Strict)
        run: |
          echo "ğŸ›ï¸ Verifying Organization Identity with Cryptographic Signature..."
          python -m steward.cli verify STEWARD.md --strict
          echo "âœ… Organization identity verified and cryptographically signed"

      - name: Verify All Resident Agents (Strict)
        run: |
          echo "ğŸ¤– Verifying Resident Agents with Cryptographic Signatures..."
          python -m steward.cli verify . --all --strict
          echo "âœ… All agents verified and cryptographically signed"

      - name: Generate Attestation Report
        if: success()
        run: |
          echo "âœ… ALL SYSTEMS COMPLIANT" > attestation_report.txt
          echo "Attestation Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> attestation_report.txt
          echo "" >> attestation_report.txt
          echo "Protocol Status:" >> attestation_report.txt
          echo "- Organization: âœ… VERIFIED" >> attestation_report.txt
          echo "- Resident Agents: âœ… VERIFIED" >> attestation_report.txt
          echo "- Compliance Level: 2 (Standard)" >> attestation_report.txt
          cat attestation_report.txt

      - name: Upload Attestation Report
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: attestation-report-${{ github.run_number }}
          path: attestation_report.txt
          retention-days: 90

      - name: Attestation Status
        if: success()
        run: |
          echo "ğŸ‰ Attestation Successful"
          echo "âœ… STEWARD Protocol compliance verified"
          echo "ğŸ“… Next attestation scheduled in 6 hours"
          echo "ğŸ”— Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: Attestation Failed
        if: failure()
        run: |
          echo "âŒ Attestation Failed"
          echo "Please review STEWARD.md files for compliance issues"
          exit 1
