name: "ðŸ¦… HERALD Staged Campaign (Human-in-the-Loop)"

on:
  # Manually trigger via GitHub UI (Workflow Dispatch)
  workflow_dispatch:

  # OR schedule daily at 09:00 UTC
  schedule:
    - cron: '0 9 * * *'

jobs:
  # ========== JOB 1: GENERATION (Brain + Artist) ==========
  draft-content:
    name: "ðŸ“ Draft Content (Brain + Artist)"
    runs-on: ubuntu-latest

    outputs:
      preview_text: ${{ steps.generate.outputs.preview_text }}
      has_image: ${{ steps.generate.outputs.has_image }}

    steps:
      # Setup
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ðŸ“¦ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install -r herald/requirements.txt

      - name: "ðŸ¥ Health Check (GAD-000)"
        run: |
          echo "âœ… Pre-flight check: Using VibeOS Kernel architecture"

      # Generate Content
      - name: "ðŸ§  Generate Content (Kernel-based)"
        id: generate
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          python herald/shim.py --action run

          # Extract preview for GitHub Output
          if [ -f dist/content.json ]; then
            PREVIEW=$(python3 -c "import json; d=json.load(open('dist/content.json')); print(d.get('text', '')[:100])" 2>/dev/null)
            echo "preview_text=${PREVIEW}" >> $GITHUB_OUTPUT
            echo "has_image=false" >> $GITHUB_OUTPUT
          fi

      # Upload Artifacts (dist/ directory)
      - name: "ðŸ“¦ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: campaign-assets
          path: dist/
          retention-days: 7

      # Summary
      - name: "ðŸ“‹ Summary"
        run: |
          echo "### âœ… Generation Phase Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Preview:** ${{ steps.generate.outputs.preview_text }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ steps.generate.outputs.has_image }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â³ Waiting for Operator Approval..." >> $GITHUB_STEP_SUMMARY

  # ========== JOB 2: HUMAN APPROVAL GATE ==========
  review-gate:
    name: "ðŸ›‘ Operator Review Gate"
    needs: draft-content
    runs-on: ubuntu-latest

    # THIS IS THE MAGIC: This environment enforces Required Reviewers
    # You must have created this in GitHub UI: Settings -> Environments -> production-approval
    # With "Required reviewers" set to your username
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      # Download the artifacts to see what we're approving
      - name: "ðŸ“¥ Download Campaign Assets"
        uses: actions/download-artifact@v4
        with:
          name: campaign-assets
          path: dist/

      # Build the visual dashboard with actual content
      - name: "ðŸ“º Generate Director's Monitor (Visual Dashboard)"
        run: |
          echo "# ðŸ¦… HERALD Campaign Proposal - Director's Monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš¦ Status: **AWAITING OPERATOR APPROVAL**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f dist/content.json ]; then
            echo "### ðŸ“ Draft Content" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tweet Text:**" >> $GITHUB_STEP_SUMMARY
            python3 -c "import json; d=json.load(open('dist/content.json')); print(f\"> {d.get('text', 'N/A')}\");" >> $GITHUB_STEP_SUMMARY || echo "N/A" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Visual Attachment:** None (text-only campaign)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No content.json found! Check generation logs." >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš–ï¸ Governance Checkpoint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **GAD-000 Compliance:** System reports cleanly" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Pre-flight Health:** All dependencies verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Content Quality Gates:** Editor + Aligner passed" >> $GITHUB_STEP_SUMMARY
          echo "- â³ **Awaiting:** Human decision (click 'Approve' below)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¬ Director's Decision" >> $GITHUB_STEP_SUMMARY
          echo "**INFORM YOUR DECISION:**" >> $GITHUB_STEP_SUMMARY
          echo "- Review the content above" >> $GITHUB_STEP_SUMMARY
          echo "- Click **Approve** to publish, **Deny** to cancel" >> $GITHUB_STEP_SUMMARY
          echo "- This is your last checkpoint before Twitter publication" >> $GITHUB_STEP_SUMMARY

      - name: "âœ… Operator Approved"
        run: |
          echo "ðŸŽ¯ Approval granted. Proceeding to publication."

      - name: "ðŸ“¢ Approval Announcement"
        run: |
          echo "### âœ… Operator Approved Publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Content approved by operator and will be published immediately." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Publishing in next phase..." >> $GITHUB_STEP_SUMMARY

  # ========== JOB 3: EXECUTION (Publisher) ==========
  execute-publish:
    name: "ðŸš€ Execute Publication"
    needs: [draft-content, review-gate]
    runs-on: ubuntu-latest

    steps:
      # Setup
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ðŸ“¦ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install -r herald/requirements.txt

      # Download Artifacts
      - name: "ðŸ“¥ Download Content Bundle"
        uses: actions/download-artifact@v4
        with:
          name: campaign-assets
          path: dist/

      # Publish
      - name: "ðŸ¦ Publish to Twitter"
        id: publish
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python herald/shim.py --action publish

      # Summary
      - name: "ðŸ“Š Publication Summary"
        if: success()
        run: |
          echo "### ðŸŽ‰ Publication Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Content published to Twitter" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Content Preview:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.draft-content.outputs.preview_text }}" >> $GITHUB_STEP_SUMMARY

      - name: "âŒ Publication Failed"
        if: failure()
        run: |
          echo "### âŒ Publication Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check logs above for details." >> $GITHUB_STEP_SUMMARY
          exit 1

  # ========== JOB 4: RESILIENCE TESTING (Optional) ==========
  chaos-tests:
    name: "ðŸ§ª Chaos Testing Suite"
    runs-on: ubuntu-latest

    # These run in parallel with draft-content, don't block publication
    # This gives you early warning if something is broken
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ðŸ“¦ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -r herald/requirements.txt

      - name: "ðŸ§ª Run Resilience Tests"
        run: |
          pytest tests/test_resilience.py -v --tb=short || echo "Tests not available (optional)"

      - name: "ðŸ“ˆ Test Summary"
        if: always()
        run: |
          echo "### ðŸ§ª Chaos Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "All system degradation scenarios tested." >> $GITHUB_STEP_SUMMARY
          echo "Check logs for details." >> $GITHUB_STEP_SUMMARY
