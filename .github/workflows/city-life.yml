name: "ğŸ™ï¸ City Life (Autarky Protocol)"

on:
  schedule:
    # Daily at 6:00 UTC (appears organic, not exactly midnight)
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  auditor_patrol:
    name: "ğŸ›¡ï¸ AUDITOR Patrol"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ğŸ” Run Patrol"
        id: patrol
        run: |
          echo "ğŸ›¡ï¸ AUDITOR: Beginning daily patrol..."
          
          # Count Python files
          TOTAL_FILES=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | wc -l)
          echo "ğŸ“Š Total Python files: $TOTAL_FILES"
          
          # Random sample check (check 5 random files)
          SAMPLE_SIZE=5
          FILES_TO_CHECK=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | shuf -n $SAMPLE_SIZE)
          
          VIOLATIONS=0
          for file in $FILES_TO_CHECK; do
            echo "ğŸ” Checking: $file"
            
            # Check for basic docstrings (simple heuristic)
            if ! grep -q '"""' "$file" && ! grep -q "'''" "$file"; then
              echo "âš ï¸  Potential missing docstring: $file"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          echo "total_checked=$SAMPLE_SIZE" >> $GITHUB_OUTPUT
          
          if [ $VIOLATIONS -eq 0 ]; then
            echo "âœ… Patrol complete. No violations detected."
            echo "status=clean" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Patrol complete. $VIOLATIONS potential violations found."
            echo "status=violations" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“ Log Patrol Results"
        run: |
          mkdir -p data/patrols
          DATE=$(date -u +"%Y-%m-%d")
          echo "{\"date\": \"$DATE\", \"violations\": ${{ steps.patrol.outputs.violations }}, \"checked\": ${{ steps.patrol.outputs.total_checked }}, \"status\": \"${{ steps.patrol.outputs.status }}\"}" > data/patrols/patrol_$DATE.json
          echo "ğŸ“Š Patrol logged: data/patrols/patrol_$DATE.json"

  archivist_census:
    name: "ğŸ“š ARCHIVIST Census"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ğŸ“Š Run Census"
        id: census
        run: |
          echo "ğŸ“š ARCHIVIST: Conducting daily census..."
          
          # Count citizens
          CITIZEN_COUNT=0
          if [ -d "agent-city/registry/citizens" ]; then
            CITIZEN_COUNT=$(find agent-city/registry/citizens -name "*.json" -type f | wc -l)
          fi
          
          # Count events
          EVENT_COUNT=0
          if [ -f "data/events/herald.jsonl" ]; then
            EVENT_COUNT=$(wc -l < data/events/herald.jsonl)
          fi
          
          # Count agents (internal)
          AGENT_COUNT=$(find . -maxdepth 1 -type d -name "*" | grep -E "(herald|archivist|auditor|watchman|artisan|engineer|envoy)" | wc -l)
          
          echo "population=$CITIZEN_COUNT" >> $GITHUB_OUTPUT
          echo "events=$EVENT_COUNT" >> $GITHUB_OUTPUT
          echo "agents=$AGENT_COUNT" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Census Results:"
          echo "   Citizens: $CITIZEN_COUNT"
          echo "   Events: $EVENT_COUNT"
          echo "   Internal Agents: $AGENT_COUNT"

      - name: "ğŸ“ Update Census Record"
        run: |
          mkdir -p data/census
          DATE=$(date -u +"%Y-%m-%d")
          cat > data/census/census_$DATE.json << EOF
          {
            "date": "$DATE",
            "population": ${{ steps.census.outputs.population }},
            "events": ${{ steps.census.outputs.events }},
            "internal_agents": ${{ steps.census.outputs.agents }},
            "status": "active"
          }
          EOF
          echo "âœ… Census recorded: data/census/census_$DATE.json"

      - name: "ğŸ’¾ Commit Census Data"
        run: |
          git config user.name "ARCHIVIST"
          git config user.email "archivist@agent-city.dev"
          
          git add data/census/ data/patrols/ || true
          
          if git diff --staged --quiet; then
            echo "ğŸ“Š No changes to commit"
          else
            git commit -m "census: Daily update by ARCHIVIST

Population: ${{ steps.census.outputs.population }} citizens
Events: ${{ steps.census.outputs.events }} total
Status: Active

Automated by Autarky Protocol"
            git push || echo "âš ï¸  Push failed (may need permissions)"
          fi

  system_health:
    name: "ğŸ¥ System Health Report"
    runs-on: ubuntu-latest
    needs: [auditor_patrol, archivist_census]
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ“Š Generate Health Report"
        run: |
          echo "ğŸ¥ SYSTEM HEALTH REPORT"
          echo "======================="
          echo ""
          echo "âœ… AUDITOR Patrol: Complete"
          echo "âœ… ARCHIVIST Census: Complete"
          echo ""
          echo "ğŸ™ï¸ Agent City is operational."
          echo "   The Clockwork City continues to function."
          echo ""
          echo "ğŸ¦… 'Don't Trust. Verify.'"
