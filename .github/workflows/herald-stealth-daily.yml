name: "ğŸ¦… HERALD Stealth Daily Campaign"

# Automatic daily technical leak campaign - no approval gate
on:
  # Daily at 09:00 UTC
  schedule:
    - cron: '0 9 * * *'

  # Manual trigger for testing
  workflow_dispatch:

jobs:
  stealth-campaign:
    name: "ğŸ¤« Generate & Publish Technical Insight"
    runs-on: ubuntu-latest

    outputs:
      tweet_generated: ${{ steps.generate.outputs.preview_text != '' }}

    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ğŸ“¦ Install Dependencies"
        run: |
          pip install --upgrade pip
          pip install -r herald/requirements.txt

      - name: "ğŸ¥ Pre-flight Check"
        run: |
          python examples/herald/health_check.py

      - name: "ğŸ§  Generate Technical Insight Tweet"
        id: generate
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          python3 << 'EOF'
          import os
          import sys
          import json
          import logging
          from pathlib import Path

          # Setup Logging
          logging.basicConfig(
              level=logging.INFO,
              format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
          )
          logger = logging.getLogger("HERALD_STEALTH")

          # Add project root to Python path
          project_root = Path.cwd()
          if str(project_root) not in sys.path:
              sys.path.insert(0, str(project_root))

          from herald.tools.content_tool import ContentTool

          # Initialize content tool
          content_tool = ContentTool()
          logger.info("ğŸ§  STEALTH CAMPAIGN: Generating technical insight tweet...")

          # Generate using campaign roadmap mode
          logger.info("ğŸ—ºï¸ Executing Campaign Roadmap Strategy...")
          tweet = content_tool.generate_campaign_tweet(roadmap_path="marketing/launch_roadmap.md")

          if not tweet or len(tweet) < 10:
              logger.error("âŒ Failed to generate tweet")
              sys.exit(1)

          # Save to dist directory for artifact
          dist_dir = Path("dist")
          dist_dir.mkdir(exist_ok=True)

          payload = {
              "text": tweet,
              "mode": "campaign_execution",
              "timestamp": str(Path(__file__))
          }

          content_file = dist_dir / "content.json"
          with open(content_file, "w") as f:
              json.dump(payload, f, indent=2)

          logger.info(f"âœ… Tweet generated ({len(tweet)} chars): {tweet[:100]}...")
          logger.info(f"âœ… Saved to dist/content.json")

          # Export for workflow visibility
          if "GITHUB_OUTPUT" in os.environ:
              output_file = os.environ["GITHUB_OUTPUT"]
              with open(output_file, "a") as gh_out:
                  clean_text = tweet.replace('\n', ' ').replace('"', '\\"')
                  gh_out.write(f"preview_text={clean_text}\n")
              logger.info("âœ… GitHub Output written")

          EOF

      - name: "ğŸ¦ Publish to Twitter"
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          python3 << 'EOF'
          import os
          import sys
          import json
          import logging
          from pathlib import Path

          logging.basicConfig(level=logging.INFO)
          logger = logging.getLogger("HERALD_PUBLISH")

          project_root = Path.cwd()
          if str(project_root) not in sys.path:
              sys.path.insert(0, str(project_root))

          from herald.tools.broadcast_tool import BroadcastTool

          # Load content
          content_file = Path("dist/content.json")
          if not content_file.exists():
              logger.error("âŒ Content file not found")
              sys.exit(1)

          with open(content_file) as f:
              payload = json.load(f)

          tweet_text = payload.get("text", "")
          if not tweet_text:
              logger.error("âŒ No tweet text found")
              sys.exit(1)

          # Publish
          broadcaster = BroadcastTool()
          try:
              result = broadcaster.execute_publish(tweet_text)
              logger.info(f"âœ… PUBLISHED: {tweet_text[:100]}...")
              logger.info(f"ğŸ“Š Publication result: {result}")
          except Exception as e:
              logger.error(f"âŒ PUBLISH FAILED: {e}")
              # Don't fail the workflow - log and continue
              logger.info("â„¹ï¸ Tweet may not have published but workflow continues")

          EOF

      - name: "ğŸ“Š Campaign Summary"
        if: success()
        run: |
          echo "### ğŸ‰ Stealth Campaign Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f dist/content.json ]; then
            echo "**Tweet Published:**" >> $GITHUB_STEP_SUMMARY
            python3 -c "import json; d=json.load(open('dist/content.json')); print(d.get('text', 'N/A'))" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "âŒ Campaign Failed"
        if: failure()
        run: |
          echo "### âŒ Stealth Campaign Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check logs for details" >> $GITHUB_STEP_SUMMARY
          exit 1

  archive:
    name: "ğŸ—ƒï¸  Archive to Chain of Trust Ledger"
    runs-on: ubuntu-latest
    needs: stealth-campaign
    if: success()

    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: "ğŸ“š Archive HERALD Broadcast to Ledger"
        run: |
          python archivist/archivist_shim.py --action archive

      - name: "ğŸ“ Commit Ledger Updates"
        run: |
          git config user.name "ARCHIVIST"
          git config user.email "archivist@steward-protocol.local"
          git add archive/ledger.json
          if git diff --cached --quiet; then
            echo "â„¹ï¸  No changes to ledger"
          else
            git commit -m "chore: ARCHIVIST - Chain of Trust Ledger Updated"
            git push origin main
          fi

      - name: "âœ… Archive Complete"
        if: success()
        run: |
          echo "### ğŸ—ƒï¸  Chain of Trust Archived" >> $GITHUB_STEP_SUMMARY
          echo "**Ledger updated and committed to main branch**" >> $GITHUB_STEP_SUMMARY
          python archivist/archivist_shim.py --action ledger >> $GITHUB_STEP_SUMMARY || true
