name: "ðŸ¦… HERALD Staged Campaign (HITL)"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * *'

permissions:
  contents: read

jobs:
  # ========== JOB 1: PRE-FLIGHT CHECK ==========
  health-check:
    runs-on: ubuntu-latest
    name: "ðŸ¥ System Diagnosis"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install & Verify
        run: |
          pip install --upgrade pip
          pip install -r herald/requirements.txt
          echo "âœ… VibeOS Kernel system ready"

  # ========== JOB 2: GENERATION (WITH ASSERTIONS) ==========
  proposal:
    needs: health-check
    runs-on: ubuntu-latest
    name: "ðŸ§  Generate Proposal"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r herald/requirements.txt

      - name: ðŸ§  Generate Content
        id: generate
        env:
          # All secrets required for Kernel boot validation
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
        run: |
          python herald/main.py --action generate

          # ASSERTION: File must exist
          if [ ! -f dist/content.json ]; then
            echo "âŒ CRITICAL: Generation failed - no output file created"
            exit 1
          fi

          # ASSERTION: File must not be empty
          if [ ! -s dist/content.json ]; then
            echo "âŒ CRITICAL: Generated file is empty"
            exit 1
          fi

          # ASSERTION: File must be valid JSON
          if ! python3 -m json.tool dist/content.json > /dev/null 2>&1; then
            echo "âŒ CRITICAL: Invalid JSON in content.json"
            exit 1
          fi

          # ASSERTION: Must have 'text' field
          if ! python3 -c "import json; d=json.load(open('dist/content.json')); assert d.get('text'), 'Missing text field'" 2>/dev/null; then
            echo "âŒ CRITICAL: content.json missing required 'text' field"
            exit 1
          fi

          echo "âœ… Content validation PASSED"

      - name: ðŸ“º Generate Preview Dashboard
        if: success()
        run: |
          echo "# ðŸ¦… HERALD Campaign Proposal - Director's Monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš¦ Status: **READY FOR YOUR REVIEW**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Draft Content" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tweet Text:**" >> $GITHUB_STEP_SUMMARY
          python3 -c "import json; d=json.load(open('dist/content.json')); print(f\"> {d.get('text', 'N/A')}\");" >> $GITHUB_STEP_SUMMARY || echo "> N/A" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Visual Attachment:** None (text-only campaign)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš–ï¸ Governance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Health Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Content Validated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Artifact Uploaded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¬ Next Step" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘‰ **Scroll down to 'review-gate' job and click 'Review deployments' to Approve or Reject.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This preview is generated BEFORE the approval gate, so you can review the content safely." >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: campaign-bundle
          path: dist/
          retention-days: 1

  # ========== JOB 3: REVIEW GATE (MINIMAL BLOCKER) ==========
  review-gate:
    needs: proposal
    runs-on: ubuntu-latest
    name: "ðŸ›‘ Operator Review Gate"
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: âœ… Approval Granted - Gate Opening
        run: |
          echo "ðŸŽ¯ Operator approved campaign." >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Proceeding to publication phase..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Content preview is available in the 'proposal' job summary above." >> $GITHUB_STEP_SUMMARY

  # ========== JOB 4: PUBLISH (ONLY AFTER APPROVAL) ==========
  execute-publish:
    needs: review-gate
    runs-on: ubuntu-latest
    name: "ðŸš€ Execute Publication"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r herald/requirements.txt

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: campaign-bundle
          path: dist/

      - name: Final Validation Before Publish
        run: |
          if [ ! -f dist/content.json ] || [ ! -s dist/content.json ]; then
            echo "âŒ ABORT: Content missing or empty"
            exit 1
          fi
          echo "âœ… Final check PASSED - safe to publish"

      - name: ðŸ¦ Publish to Twitter
        env:
          # All secrets required for Kernel boot validation
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          REDDIT_CLIENT_ID: ${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET: ${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USERNAME: ${{ secrets.REDDIT_USERNAME }}
          REDDIT_PASSWORD: ${{ secrets.REDDIT_PASSWORD }}
        run: |
          python herald/main.py --action publish

      - name: ðŸ“Š Publication Summary
        if: success()
        run: |
          echo "### ðŸŽ‰ Publication Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Content published to Twitter" >> $GITHUB_STEP_SUMMARY
