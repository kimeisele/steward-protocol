#!/usr/bin/env python3
"""Agent City CLI - Unified interface for Agent City OS (Phase 1)"""

import argparse
import sys
from pathlib import Path

# Add project root to path
PROJECT_ROOT = Path(__file__).parent.parent
sys.path.insert(0, str(PROJECT_ROOT))

from vibe_core.task_management import TaskManager
from vibe_core.kernel_impl import RealVibeKernel


def cmd_task_add(args):
    """Add a task."""
    tm = TaskManager(PROJECT_ROOT)
    task = tm.add_task(args.description, priority=args.priority)
    print(f"âœ… Task added: {args.description}")
    print(f"   ID: {task.id}")
    return 0


def cmd_task_list(args):
    """List tasks."""
    tm = TaskManager(PROJECT_ROOT)
    mission = tm.get_active_mission()
    tasks = tm.list_tasks()

    if mission and mission.current_task:
        print(f"ğŸ“‹ Current task: {mission.current_task}")
    elif tasks:
        next_task = tm.get_next_task()
        if next_task:
            print(f"ğŸ“‹ Next task: {next_task.title}")

    if tasks:
        print(f"\nğŸ“Š Tasks ({len(tasks)}):")
        for task in tasks[:10]:  # Show top 10
            status_icon = {
                "PENDING": "â³",
                "IN_PROGRESS": "â–¶ï¸",
                "COMPLETED": "âœ…",
                "BLOCKED": "ğŸš«",
            }.get(task.status.value, "â“")
            print(f"  {status_icon} P{task.priority}: {task.title}")
    else:
        print("ğŸ“­ No tasks yet. Add one with: agent-city task add \"your task\"")

    return 0


def cmd_status(args):
    """Show system status."""
    try:
        kernel = RealVibeKernel()
        kernel.boot()
        status = kernel.get_status()

        print("âœ… Agent City Status:")
        print(f"   Agents registered: {status.get('agents_registered', 0)}")
        print(f"   Manifests: {status.get('manifests', 0)}")
        print(f"   Ledger events: {status.get('ledger_events', 0)}")

        return 0
    except Exception as e:
        print(f"âŒ Error getting status: {e}")
        return 1


def cmd_mission(args):
    """Execute a mission."""
    print(f"ğŸš€ Mission mode: {args.description}")
    print("   (Mission execution coming in Phase 2)")
    return 0


def main():
    """Main entry point."""
    parser = argparse.ArgumentParser(
        prog="agent-city",
        description="Agent City CLI - Control the multi-agent system"
    )

    # Global options
    parser.add_argument(
        "--mission",
        dest="mission_desc",
        help="Run in mission mode with description"
    )

    subparsers = parser.add_subparsers(dest="command")

    # task subcommand
    task_parser = subparsers.add_parser("task")
    task_subparsers = task_parser.add_subparsers(dest="task_command")

    # task add
    task_add = task_subparsers.add_parser("add")
    task_add.add_argument("description")
    task_add.add_argument("-p", "--priority", type=int, default=0, help="Task priority (0-100)")
    task_add.set_defaults(func=cmd_task_add)

    # task list
    task_list = task_subparsers.add_parser("list")
    task_list.set_defaults(func=cmd_task_list)

    # status subcommand
    status_parser = subparsers.add_parser("status")
    status_parser.set_defaults(func=cmd_status)

    # Parse arguments
    args = parser.parse_args()

    # Handle mission mode
    if args.mission_desc:
        return cmd_mission(type('Args', (), {'description': args.mission_desc})())

    # Handle subcommands
    if hasattr(args, 'func'):
        return args.func(args)
    else:
        parser.print_help()
        return 0


if __name__ == "__main__":
    sys.exit(main())
