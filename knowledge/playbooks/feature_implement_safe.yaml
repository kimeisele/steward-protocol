# ðŸ›¡ï¸ PLAYBOOK: SAFE FEATURE IMPLEMENTATION (GAD-5500)
# The Sacred Loop: Engineer â†’ Auditor â†’ Chronicle
#
# This playbook implements the "Safe Evolution Loop":
# 1. ENGINEER writes code (in sandbox)
# 2. AUDITOR verifies (syntax, linter, tests)
# 3. CONDITIONAL GATE: If audit FAILS â†’ Loop back to Engineer
# 4. CHRONICLE commits (only if audit PASSED)
#
# Philosophy: No code is committed without audit approval.
# The Auditor is the Conscience that guards the Commit Gate.

playbook:
  id: "FEATURE_IMPLEMENT_SAFE_V1"
  name: "Safe Feature Implementation (Engineer â†’ Audit â†’ Commit)"
  intent_match:
    primary: "implement_feature"
    secondary: ["add_feature", "write_code_safe", "implement_with_audit"]

  description: |
    Deterministic feature implementation with mandatory code audit before commit.

    The Sacred Loop (GAD-5500):
    1. ENGINEER writes code (sandboxed)
    2. AUDITOR verifies code quality (syntax, linting, tests)
    3. GATE evaluates audit result
       - If FAILED: Loop back to Engineer for fixes
       - If PASSED: Continue to commit
    4. CHRONICLE seals changes with signed commit

    This ensures: NO CODE IS COMMITTED WITHOUT AUDIT APPROVAL

  phases:
    # ==================== PHASE 1: ENGINEER WRITES CODE ====================
    - phase_id: "phase_1_engineer_write"
      name: "Engineer Writes Code"
      description: "ENGINEER agent writes code based on feature specification"

      actions:
        - action_type: "CALL_AGENT"
          agent_id: "engineer"
          method: "write_code"
          params:
            # These are template vars from intent
            prompt: "{{ feature_description }}"
            target_files: "{{ target_files }}"
            context: "{{ project_context }}"

      on_success: "phase_2_audit_verify"
      on_failure: "phase_final_abort"
      timeout_seconds: 120  # Engineers need time
      requires_approval: false
      state_var: "code_written"


    # ==================== PHASE 2: AUDITOR VERIFIES ====================
    - phase_id: "phase_2_audit_verify"
      name: "Auditor Verifies Code Quality"
      description: "AUDITOR checks syntax, linting, tests, and compliance (GAD-5500)"

      actions:
        - action_type: "CALL_AGENT"
          agent_id: "auditor"
          method: "verify_changes"
          params:
            # Path comes from Engineer's manifest_reality output
            path: "{{ code_written.path }}"

      on_success: "phase_3_evaluate_audit"
      on_failure: "phase_3_evaluate_audit"  # Go to eval even on "failure" (we handle it there)
      timeout_seconds: 60  # Audits can take time
      state_var: "audit_result"


    # ==================== PHASE 3: EVALUATE AUDIT RESULT ====================
    - phase_id: "phase_3_evaluate_audit"
      name: "Evaluate Audit Result"
      description: "Gate: Check if audit PASSED. If FAILED, loop back to Engineer."

      actions:
        - action_type: "CHECK_STATE"
          target: "audit_gate"
          params:
            check_field: "audit_result.passed"
            expected_value: true
            on_mismatch: "audit_failed"

      # If audit PASSED, proceed to commit
      on_success: "phase_4_chronicle_seal"
      # If audit FAILED, emit event and loop back
      on_failure: "phase_3b_audit_failed_loop"
      timeout_seconds: 10
      state_var: "audit_validated"


    # ==================== PHASE 3B: AUDIT FAILED - LOOP BACK ====================
    - phase_id: "phase_3b_audit_failed_loop"
      name: "Audit Failed - Report and Loop Back"
      description: "Auditor rejected code. Report failures and return to Engineer for fixes."

      actions:
        # Emit failure event (for logging/UI)
        - action_type: "EMIT_EVENT"
          target: "audit_failed_notification"
          params:
            failures: "{{ audit_result.reason }}"
            phase: "code_quality_check"

      # Loop back to Engineer
      on_success: "phase_1_engineer_write"
      on_failure: "phase_final_abort"
      timeout_seconds: 10
      state_var: "audit_failed_reported"


    # ==================== PHASE 4: ARCHIVIST SEALS HISTORY ====================
    - phase_id: "phase_4_chronicle_seal"
      name: "Archivist Seals History (Create Signed Commit)"
      description: "ONLY after Audit PASSED: ARCHIVIST creates signed commit (GAD-5500)"

      actions:
        - action_type: "CALL_AGENT"
          agent_id: "archivist"
          method: "seal_history"
          params:
            source_path: "{{ code_written.path }}"
            dest_path: "{{ code_written.path }}"
            audit_result: "{{ audit_result }}"
            message: "{{ feature_name }} (audited and verified)"

      on_success: "phase_5_complete_success"
      on_failure: "phase_final_abort"
      timeout_seconds: 30
      requires_approval: false  # No manual approval needed (Auditor already approved)
      state_var: "commit_sealed"


    # ==================== PHASE 5: SUCCESS ====================
    - phase_id: "phase_5_complete_success"
      name: "Complete - Feature Implemented"
      description: "Feature successfully implemented, audited, and committed"

      actions:
        - action_type: "EMIT_EVENT"
          target: "feature_implemented_success"
          params:
            feature_name: "{{ feature_name }}"
            status: "success"
            message: "âœ… Feature implemented, audited, and committed"

      on_success: "COMPLETE"
      on_failure: "ABORT"
      timeout_seconds: 10
      state_var: "completed_successfully"


    # ==================== PHASE FINAL: ABORT ====================
    - phase_id: "phase_final_abort"
      name: "Abort - Feature Implementation Failed"
      description: "Something went wrong. Abort workflow and report."

      actions:
        - action_type: "EMIT_EVENT"
          target: "feature_implementation_failed"
          params:
            reason: "Unexpected error or user abort"
            last_phase: "{{ current_phase }}"

      on_success: "ABORT"
      on_failure: "ABORT"
      timeout_seconds: 5
      state_var: "aborted"


  # ==================== TEMPLATE VARIABLES ====================
  variables:
    feature_name: "New Feature"
    feature_description: "Detailed description of what the feature should do"
    target_files: []
    project_context: "default"


# ==================== EXPLANATION ====================
#
# KEY SAFETY MECHANISM: The "Audit Gate" (Phase 4)
#
# The gate evaluates: audit_result.passed == true
#
# If TRUE:  -> Chronicle seals (commit created)
# If FALSE: -> Loop back to Engineer (no commit created)
#
# This ensures:
# âœ… NO CODE IS COMMITTED WITHOUT AUDIT APPROVAL
# âœ… ENGINEER can fix and re-submit
# âœ… AUDITOR is the Conscience guarding the Commit Gate
# âœ… CHRONICLE only commits verified code
#
# The difference between Skynet (chaos) and Steward (order):
# In Skynet: An agent could write code and commit autonomously (dangerous)
# In Steward: Code must pass the Auditor BEFORE Chronicle commits (safe)
#
# This is GAD-5500: The Safe Evolution Loop.
