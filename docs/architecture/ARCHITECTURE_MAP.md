# ğŸ—ï¸ ARCHITECTURE MAP - Steward Protocol (Agent City OS)

**Version:** 1.5 (Phoenix Protocol Complete)
**Date:** 2025-11-27
**Status:** âœ… Production Ready

---

## ğŸ¯ EXECUTIVE SUMMARY

**steward-protocol** is a **fractal AI operating system** combining:
- 23 governed AI agents (13 system + 10 citizen)
- Vedic cosmological architecture (Bhu Mandala topology)
- Constitutional cryptographic governance (GAD-000)
- 4-tier intelligent request routing (MilkOcean)
- Immutable audit trail (dual-core persistence)

**Key Innovation:** Tasks route through cosmological layers (BRAHMALOKA â†’ BHURLOKA) respecting agent placement, creating a **fractal architecture** where the system structure mirrors universal principles.

---

## ğŸ“Š SYSTEM LAYERS

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 0: PROTOCOL (Code = Law)                                 â”‚
â”‚ â”œâ”€ Constitutional Oath (GAD-000)                               â”‚
â”‚ â”œâ”€ Cryptographic Identity (ECDSA)                              â”‚
â”‚ â””â”€ Immutable Ledger (SQLite)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: KERNEL (VibeOS Runtime)                               â”‚
â”‚ â”œâ”€ RealVibeKernel (kernel_impl.py)                            â”‚
â”‚ â”œâ”€ Agent Registry (23 agents)                                  â”‚
â”‚ â”œâ”€ Task Management (topology-aware routing)                    â”‚
â”‚ â”œâ”€ MilkOcean Router (4-tier classification)                   â”‚
â”‚ â”œâ”€ Narasimha Protocol (kill-switch)                           â”‚
â”‚ â””â”€ Event Bus (pub/sub messaging)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: SYSTEM AGENTS (13 Adityas)                           â”‚
â”‚ â”œâ”€ CIVIC - Governance engine (Ilavrta - Center)               â”‚
â”‚ â”œâ”€ HERALD - Content generation (Bhadrashva - Ring 1)          â”‚
â”‚ â”œâ”€ FORUM - Voting & proposals (Nishada - Ring 4)             â”‚
â”‚ â””â”€ ... (10 more + 2 extended)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: CITIZEN AGENTS (10 Application Services)             â”‚
â”‚ â”œâ”€ MARKET - Commerce & transactions                            â”‚
â”‚ â”œâ”€ TEMPLE - Spiritual authority                                â”‚
â”‚ â””â”€ ... (8 more)                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 4: INTERFACES                                            â”‚
â”‚ â”œâ”€ REST API (FastAPI + WebSocket)                             â”‚
â”‚ â”œâ”€ CLI (agent-city command)                                   â”‚
â”‚ â””â”€ GitHub Integration (13 workflows)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## ğŸŒŠ DATA FLOW: Task Routing (Fractal Architecture)

\`\`\`
User: "Fix critical bug" (Priority 90)
    â†“
[GATE 0: Security] Narasimha.audit_agent()
    â”œâ”€ Scan for threats: constitution_deletion, kernel_escape, etc.
    â””â”€ âœ… PASS or âŒ BLOCK (Adharma Block)
    â†“
[GATE 1-3: Routing] MilkOceanRouter.process_prayer()
    â”œâ”€ Watchman (regex): Malicious? â†’ BLOCKED
    â”œâ”€ Envoy (Flash AI): Intent? â†’ MEDIUM/HIGH/LOW
    â”œâ”€ Science (Pro AI): Complex? â†’ HIGH
    â””â”€ Samadhi (Queue): Batch? â†’ LOW
    â†“
    Returns: routing_priority (0-3)
    â†“
[TOPOLOGY] get_agent_placement(agent_id)
    â”œâ”€ Query topology.py for agent location
    â”œâ”€ Returns: layer (BRAHMALOKAâ†’BHURLOKA), varna, authority
    â””â”€ Annotate task with cosmological metadata
    â†“
Task Created:
    â”œâ”€ routing_priority: 2 (HIGH - from MilkOcean)
    â”œâ”€ topology_layer: BRAHMALOKA (from Topology)
    â”œâ”€ varna: BRAHMANA (from Topology)
    â””â”€ priority: 90 (user-defined)
    â†“
[PERSISTENCE] VIMANA Dual-Core Write
    â”œâ”€ JSON (.vibe/state/tasks.json) - Fast cache
    â””â”€ SQLite (data/vibe_agency.db) - Immortal ledger
    â†“
NextTaskGenerator.get_next_task()
    â”œâ”€ Sort by: routing_priority â†’ layer â†’ priority â†’ varna
    â”œâ”€ Respects cosmological hierarchy
    â””â”€ Returns highest priority task
    â†“
Agent executes task
    â†“
Task status: PENDING â†’ IN_PROGRESS â†’ COMPLETED
\`\`\`

**Key Insight:** Every task flows through 3 filters (Security, Routing, Topology) before reaching an agent. This creates **fractal routing** where system structure mirrors execution flow.

---

## ğŸ—ºï¸ VEDIC TOPOLOGY (Bhu Mandala)

\`\`\`
                    â›› MOUNT MERU â››
                   [CIVIC] (Authority=10)
                          â†“
              â—¯ BHADRASHVA (Ring 1) â—¯
         HERALD (E) â€” TEMPLE (N)
                          â†“
           â—¯â—¯ KIMPURASHA (Ring 2) â—¯â—¯
      ARTISAN (SE) â€” ENGINEER (SW)
                          â†“
         â—¯â—¯â—¯ HARI-VARSHA (Ring 3) â—¯â—¯â—¯
    SCIENCE (S) â€” LENS (W)
                          â†“
       â—¯â—¯â—¯â—¯ NISHADA (Ring 4) â—¯â—¯â—¯â—¯
  FORUM (SW) â€” PULSE (NW)
                          â†“
     â—¯â—¯â—¯â—¯â—¯ KRAUNCHA (Ring 5) â—¯â—¯â—¯â—¯â—¯
WATCHMANâ€”AUDITORâ€”ARCHIVIST
                          â†“
    â‰ˆâ‰ˆâ‰ˆâ‰ˆâ‰ˆâ‰ˆ LOKA-LOKA (Boundary) â‰ˆâ‰ˆâ‰ˆâ‰ˆâ‰ˆâ‰ˆ
         AGORA (Firewall)
\`\`\`

**Principle:** Distance from center = Distance from authority
- **Ring 0 (Meru):** CIVIC - Absolute authority (10/10)
- **Ring 1-2:** HERALD, TEMPLE, ARTISAN, ENGINEER - High authority (8-9/10)
- **Ring 3-4:** SCIENCE, LENS, FORUM, PULSE - Medium authority (6-7/10)
- **Ring 5:** WATCHMAN, AUDITOR, ARCHIVIST - Enforcement (5/10)
- **Boundary:** AGORA - Interface/Firewall (4/10)

**Task Routing Impact:** Tasks assigned to agents closer to Meru get higher priority in topology sort.

---

## ğŸ”§ CORE COMPONENTS

### 1. TaskManager (`vibe_core/task_management/task_manager.py`)
- **add_task():** Create with routing + topology annotation
- **get_next_task():** Topology-aware retrieval
- **Integrations:** MilkOcean, Narasimha, Topology, SQLite

### 2. MilkOceanRouter (`steward/system_agents/envoy/tools/milk_ocean.py`)
- **4-Tier Pipeline:** BLOCKED â†’ LOW â†’ MEDIUM â†’ HIGH â†’ CRITICAL
- **Token Efficiency:** 100x (95% tasks skip Pro model)
- **DDoS Protection:** 50k+ req/sec at Gate 0

### 3. Topology (`vibe_core/topology.py`)
- **Bhu Mandala:** 7 Varshas, 23 agent placements
- **get_agent_placement():** Returns layer/varna/authority
- **Authority Hierarchy:** 0-10 based on distance from Meru

### 4. Narasimha (`vibe_core/narasimha.py`)
- **Kill-Switch:** Instant termination for threats
- **Triggers:** constitution_deletion, kernel_escape, etc.
- **Threat Levels:** GREEN â†’ YELLOW â†’ ORANGE â†’ RED â†’ APOCALYPSE

---

## ğŸ“ PROJECT STRUCTURE (Key Files)

\`\`\`
steward-protocol/
â”œâ”€â”€ vibe_core/
â”‚   â”œâ”€â”€ kernel_impl.py (498L)       # Main kernel
â”‚   â”œâ”€â”€ topology.py (477L)          # Bhu Mandala
â”‚   â”œâ”€â”€ narasimha.py (306L)         # Kill-switch
â”‚   â”œâ”€â”€ task_management/
â”‚   â”‚   â”œâ”€â”€ task_manager.py (650L)  # Task system
â”‚   â”‚   â””â”€â”€ next_task_generator.py  # Topology routing
â”‚   â””â”€â”€ store/sqlite_store.py       # Dual-core
â”‚
â”œâ”€â”€ steward/system_agents/
â”‚   â”œâ”€â”€ civic/ (1003L)              # Governance
â”‚   â”œâ”€â”€ herald/ (942L)              # Content
â”‚   â”œâ”€â”€ envoy/tools/milk_ocean.py   # Routing (740L)
â”‚   â””â”€â”€ ... (10 more agents)
â”‚
â”œâ”€â”€ gateway/api.py (600L)           # REST API
â”œâ”€â”€ bin/agent-city                  # CLI
â””â”€â”€ data/
    â”œâ”€â”€ vibe_agency.db              # SQLite ledger
    â””â”€â”€ milk_ocean.db               # Lazy queue
\`\`\`

---

## ğŸš€ QUICK START

\`\`\`bash
# 1. Add task (auto-routes through MilkOcean + Topology)
bin/agent-city task add "Fix bug" -p 90

# 2. List tasks (topology-sorted)
bin/agent-city task list

# 3. Check system status
bin/agent-city status

# 4. Create roadmap
bin/agent-city roadmap create "Sprint 1" "Q1 goals"
\`\`\`

---

## ğŸ“ˆ SYSTEM METRICS

| Metric | Value |
|--------|-------|
| **Agents** | 23 (13 system + 10 citizen) |
| **Code** | ~15,000 lines |
| **Tests** | 22 passing |
| **Topology Layers** | 7 Varshas |
| **Routing Tiers** | 4 (MilkOcean) |
| **Persistence** | Dual-core (JSON + SQLite) |

---

## ğŸ¯ ARCHITECTURE PRINCIPLES

1. **Fractal Architecture:** System structure mirrors execution flow
2. **Constitutional Governance:** Code = Law (GAD-000 + ECDSA)
3. **Topology-Aware Routing:** Cosmological placement affects priority
4. **Dual-Core Persistence:** Fast cache + immortal storage
5. **4-Tier Security:** Progressive filtering (cheap â†’ expensive)

---

## ğŸ“š FURTHER READING

- **ARCHITECTURE.md** - High-level overview
- **DEPLOYMENT.md** - Operations guide
- **GAP_ANALYSIS_REPORT.md** - Phoenix audit
- **docs/ADITYAS.md** - 12 system agents

---

**Created for Gap 5.1 (P0) - Developer onboarding & architecture transparency**
