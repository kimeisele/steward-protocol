<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VibeChat // GAD-3000 // AJNA</title>
    <style>
        body { background: #0a0a0a; color: #00ff41; font-family: monospace; padding: 2rem; max-width: 800px; margin: 0 auto; }
        h1 { border-bottom: 2px solid #00ff41; padding-bottom: 10px; }
        #log { background: #111; border: 1px solid #333; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; white-space: pre-wrap; }
        #input-area { display: flex; gap: 10px; }
        input { flex-grow: 1; background: #000; border: 1px solid #00ff41; color: #fff; padding: 10px; font-family: monospace; }
        button { background: #00ff41; color: #000; border: none; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        button:hover { background: #fff; }
        .system { color: #888; }
        .user { color: #0ff; font-weight: bold; }
        .agent { color: #f0f; }
    </style>
</head>
<body>
    <h1>üëÅÔ∏è VIBE_CHAT // IDENTITY FUSION</h1>
    <div id="status">INITIALIZING OPTICAL NERVE...</div>
    <div id="log"></div>
    <div id="input-area">
        <input type="text" id="cmd" placeholder="Enter command (e.g., 'status', 'briefing')..." autofocus>
        <button onclick="sendCommand()">TRANSMIT</button>
    </div>

    <script src="identity_wallet.js"></script>
    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        const input = document.getElementById('cmd');

        function appendLog(text, type='system') {
            log.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${text}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // 1. BOOT IDENTITY
        window.onload = async () => {
            try {
                const pubKey = await window.wallet.init();
                status.innerText = `‚úÖ IDENTITY FUSED: ${pubKey.substring(0,24)}...`;
                appendLog(`Identity Wallet Active.\nPublic Key: ${pubKey}`, 'system');
            } catch (e) {
                status.innerText = "‚ùå BLIND: Wallet Init Failed";
                status.style.color = "red";
                console.error(e);
            }
        };

        // 2. TRANSMIT (SIGN & SEND)
        async function sendCommand() {
            const txt = input.value;
            if (!txt) return;

            appendLog(`> ${txt}`, 'user');
            input.value = "";

            try {
                // A. SIGN
                appendLog("üîí Signing payload...", 'system');
                const signedPayload = await window.wallet.signPayload(txt);

                // B. SEND
                const response = await fetch('/v1/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(signedPayload)
                });

                const data = await response.json();

                // C. DISPLAY
                if (data.status === "success" || data.status === "SUBMITTED") {
                    appendLog(`üëÅÔ∏è AGENT RESPONSE:\n${JSON.stringify(data.summary || data, null, 2)}`, 'agent');
                } else {
                    appendLog(`‚ùå ERROR: ${JSON.stringify(data)}`, 'system');
                }

            } catch (e) {
                appendLog(`‚ùå TRANSMISSION FAILURE: ${e.message}`, 'system');
            }
        }

        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendCommand();
        });
    </script>
</body>
</html>