<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VibeChat // GAD-3000</title>
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Courier New', monospace; padding: 2rem; max-width: 900px; margin: 0 auto; }
        #log { background: #000; border: 1px solid #333; height: 400px; overflow-y: scroll; padding: 15px; margin-bottom: 20px; white-space: pre-wrap; }
        #input-area { display: flex; border: 1px solid #00ff41; }
        input { flex-grow: 1; background: #000; border: none; color: #fff; padding: 15px; outline: none; }
        button { background: #00ff41; color: #000; border: none; padding: 0 30px; cursor: pointer; font-weight: bold; }
        .user { color: #0ff; margin-top: 10px; display: block; }
        .agent { color: #f0f; margin-bottom: 10px; display: block; border-left: 2px solid #f0f; padding-left: 10px; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üëÅÔ∏è VIBE_CHAT // FINAL // GAD-3000</h1>
    <div id="status">OFFLINE</div>
    <div id="log"></div>
    <div id="input-area">
        <input type="text" id="cmd" placeholder="Loading..." disabled>
        <button id="btn" onclick="sendCommand()" disabled>LOCKED</button>
    </div>

    <script>
        // --- WALLET CORE ---
        const DB_NAME = "VibeChat_Identity_v1";
        class IdentityWallet {
            constructor() { this.keyPair = null; this.db = null; }
            async init() {
                if (!window.crypto.subtle) throw new Error("Insecure Context (Use localhost!)");
                await this._openDB();
                const existing = await this._getKey();
                if (existing) this.keyPair = existing;
                else { this.keyPair = await this._genKeys(); await this._saveKey(this.keyPair); }
                return await this._expKey(this.keyPair.publicKey);
            }
            async sign(msg) {
                const enc = new TextEncoder().encode(msg);
                const sig = await window.crypto.subtle.sign({name:"ECDSA", hash:"SHA-256"}, this.keyPair.privateKey, enc);
                return {
                    message: msg, signature: this._hex(sig),
                    public_key: await this._expKey(this.keyPair.publicKey),
                    agent_id: "HIL_OPERATOR", timestamp: Date.now()
                };
            }
            async _genKeys() { return window.crypto.subtle.generateKey({name:"ECDSA", namedCurve:"P-256"}, false, ["sign","verify"]); }
            async _expKey(k) { return this._hex(await window.crypto.subtle.exportKey("spki", k)); }
            _hex(buf) { return [...new Uint8Array(buf)].map(x=>x.toString(16).padStart(2,'0')).join(''); }
            _openDB() { return new Promise((r,j)=>{ const q=indexedDB.open(DB_NAME,1); q.onupgradeneeded=e=>e.target.result.createObjectStore("keys"); q.onsuccess=e=>{this.db=q.result;r()}; q.onerror=j; }); }
            _getKey() { return new Promise(r=>{ const t=this.db.transaction("keys","readonly").objectStore("keys").get("hil"); t.onsuccess=()=>r(t.result); }); }
            _saveKey(k) { return new Promise(r=>{ const t=this.db.transaction("keys","readwrite").objectStore("keys").put(k,"hil"); t.oncomplete=r; }); }
        }

        // --- APP LOGIC ---
        const log = document.getElementById('log');
        const input = document.getElementById('cmd');
        const btn = document.getElementById('btn');
        let wallet = null;

        function append(txt, type) {
            const t = new Date().toLocaleTimeString();
            log.innerHTML += `<div class="${type}">[${t}] ${txt}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        (async () => {
            try {
                wallet = new IdentityWallet();
                const pk = await wallet.init();
                input.disabled = false; btn.disabled = false; input.placeholder = "Enter command..."; btn.innerText = "SEND";
                document.getElementById('status').innerText = "ONLINE | SECURE";
                document.getElementById('status').style.color = "#00ff41";
                append(`IDENTITY FUSED.\nPK: ${pk.substring(0,16)}...`, "system");
            } catch(e) { append(`BOOT ERROR: ${e.message}`, "error"); }
        })();

        async function sendCommand() {
            const txt = input.value.trim();
            if(!txt) return;
            append(`> ${txt}`, "user");
            input.value = "";
            try {
                const payload = await wallet.sign(txt);

                // FORCE URL TO LOCALHOST
                const res = await fetch("http://localhost:8000/v1/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "x-api-key": "steward-secret-key" },
                    body: JSON.stringify(payload)
                });

                if(!res.ok) throw new Error(`Server Error: ${res.status}`);
                const data = await res.json();
                append(data.summary || JSON.stringify(data), "agent");
            } catch(e) { append(`ERROR: ${e.message}`, "error"); }
        }
        input.addEventListener("keypress", e=>{if(e.key==="Enter") sendCommand()});
    </script>
</body>
</html>
